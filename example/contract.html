var contract;
var contractAdres = '0x8bf76c63612aa721414b7853bd184b7c7412cf5f';
var contractAbi = [{"constant":false,"inputs":[{"name":"number","type":"uint16"}],"name":"getAdres","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"die","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"number","type":"uint16"}],"name":"getBalance","outputs":[{"name":"","type":"int256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"number","type":"uint16"}],"name":"getType","outputs":[{"name":"","type":"uint8"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"point","type":"uint8"},{"name":"id","type":"uint8"}],"name":"checkPoint","outputs":[{"name":"","type":"uint8"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"number","type":"uint16"}],"name":"getSum","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"number","type":"uint16"},{"name":"point","type":"uint8"}],"name":"main","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"adres","type":"address"},{"name":"carType","type":"uint8"},{"name":"number","type":"uint16"}],"name":"addCar","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"carNum","type":"uint16"}],"name":"getId","outputs":[{"name":"","type":"uint16"}],"payable":false,"type":"function"},{"inputs":[],"payable":false,"type":"constructor"},{"payable":true,"type":"fallback"}];
var carNumberTC;

const UNDENTIFIED = 0;
const LIGHTWEIGHT = 1;
const TRUCK = 2;
const SPECIAL = 3;

window.onload = function(){

if(typeof web3 !== 'undefined' && typeof Web3 !== 'undefined') {
    // If there's a web3 library loaded, then make your own web3
    web3 = new Web3(web3.currentProvider);
} else if (typeof Web3 !== 'undefined') {
    // If there isn't then set a provider
    web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
} else if(typeof web3 == 'undefined') {
    // Alert the user he is not in a web3 compatible browser
  messageWindow("Установите Mist браузер");
}

web3.eth.defaultAccount = '0x7A914779a43E62F3bc357250D9a7b6F400414363';

contract = web3.eth.contract(contractAbi).at(contractAdres);

var carNumber = document.getElementById("carNumber");

var carType = document.getElementById("carType");


var carAddress = document.getElementById("carAddress");

var pointNum = document.getElementById("numOfPointToCheck");

carNumberTC = document.getElementById("numOfCarToCheck");

var reg = document.getElementById("reg");
var resultText = document.getElementById("resultText");
if(reg!=null){
reg.onclick = function() { carRegistration(carAddress.value,parseInt(carType.value),parseInt(carNumber.value)); };
}

var del = document.getElementById("del");

if(del!=null){
del.onclick = function() { deleteContract(); };
}

var result = document.getElementById("result");
if(result!=null){
result.onclick = function(){checkResult(parseInt(pointNum.value),parseInt(carNumberTC.value));};
}

}


function deleteContract(){ //Удаление контракта - есть
  //web3.personal.unlockAccount(web3.eth.defaultAccount,"CityCoin",15000);
  contract.die({from:web3.eth.defaultAccount});
}


function messageWindow(msg){
  var span = document.createElement("span");
  
  span.className = "dapp-block-button";
  span.innerHTML = msg;
  
  document.body.appendChild(span);
  
  setTimeout(function() {
    span.remove();
  }, 2500);
}

 function checkResult(point,num){
  if(num.toString().length == 4 && point.toString().length == 1){
      //web3.personal.unlockAccount(web3.eth.defaultAccount,"CityCoin",15000);
      resultText.innerHTML = "Машина с номером "+carNumberTC +" и типом " +contract.getType(num).toString();
	}

  else if(num.toString().length !=4){
    messageWindow("Номер машины должен состоять из 5 цифр");
  }

  else if(point.toString().length !=1){
    messageWindow("Точка должна состоять из одной цифры");
  }
}


function carRegistration(adr,car,num){//регистрация машины - есть
  if(num.toString().length == 4 && car.toString().length == 1 && car>0 && car<4 && web3.isAddress(adr)){
  //web3.personal.unlockAccount(web3.eth.defaultAccount,"CityCoin",15000);
	contract.addCar(adr,car,num,{from:web3.eth.defaultAccount}); 
  }
  else if(num.toString().length!=4){
    messageWindow("Номер машины должен состоять из 4 цифр");
  }
  else if(car.toString().length!=1 || car<1 || car>3){
    messageWindow("Тип машины указывается одной цифрой с 1 до 3");
  }
  else if(!web3.isAddress(adr)){
    messageWindow("Вы указали некорректный адрес");
  }
}
